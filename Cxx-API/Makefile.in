#
# Copyright (C) 2004 Stefan Seefeld
# All rights reserved.
# Licensed to the public under the terms of the GNU LGPL (>= 2),
# see the file COPYING for details.
#

SHELL	:= /bin/sh

srcdir	:= @srcdir@
synopsis:= python synopsis.py

PYTHON	:= @PYTHON@

CC	:= @CC@
CXX	:= @CXX@
MAKEDEP	:= $(CXX) -M
CPPFLAGS:= @CPPFLAGS@ -I $(srcdir)/include -I @PYTHON_INCLUDE@
CFLAGS	:= @CFLAGS@
CXXFLAGS:= @CXXFLAGS@
LDFLAGS	:= @LDFLAGS@
LIBS	:= @LIBS@ -lpthread

HDR	:= $(shell find $(srcdir)/include -name '*.hh' -print)
SRC	:= Trace.cc Path.cc ErrorHandler.cc
OBJ	:= $(patsubst %.cc, src/%.o, $(SRC))
HDR_SYN	:= $(patsubst $(srcdir)/%, %.syn, $(HDR))
CC_SYN	:= $(patsubst %, src/%.syn, $(SRC))

TARGET	:= lib/libSynopsis.a

vpath %.cc $(srcdir)/src
vpath %.hh $(srcdir)

all: $(TARGET)

doc: cxx-api.syn cxx-api-impl.syn

# Link C++ files together
cxx-api.syn: $(HDR_SYN)
	@echo linking C++ headers together
	$(synopsis) link_cxx --output=$@ $^

cxx-api-impl.syn: $(HDR_SYN) $(CC_SYN)
	@echo linking all C++ files together
	$(synopsis) link_cxx --output=$@ $^

src/%.o : %.cc
	$(CXX) $(CPPFLAGS) $(CXXFLAGS) -c -o $@ $<

# Compile C++ .hh files
$(HDR_SYN): %.syn: %
	@echo parsing $^
	mkdir -p $(dir $@)
	$(synopsis) cxx --output=$@ $?

# Compile C++ .cc files
$(CC_SYN): src/%.syn: %
	@echo parsing $^
	mkdir -p $(dir $@)
	$(synopsis) cxx --output=$@ $?

$(TARGET): $(OBJ)
	ar rcs $@ $(OBJ)

clean :
	rm -f $(srcdir)/src/*~ src/*.o src/*.syn $(TARGET)
