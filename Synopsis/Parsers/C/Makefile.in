#
# Copyright (C) 2004 Stefan Seefeld
# All rights reserved.
# Licensed to the public under the terms of the GNU LGPL (>= 2),
# see the file COPYING for details.
#

SHELL	:= /bin/sh

srcdir	:= @srcdir@
synopsis:= python synopsis.py

PYTHON	:= @PYTHON@

CC	:= @CC@
CXX	:= @CXX@
MAKEDEP	:= $(CXX) -M
YACC	:= @YACC@
LEX	:= @LEX@
CPPFLAGS:= @CPPFLAGS@ -I . -I $(srcdir) -I $(srcdir)/../../../Cxx-API/include -I @PYTHON_INCLUDE@
CFLAGS	:= @CFLAGS@
CXXFLAGS:= @CXXFLAGS@
LDFLAGS	:= @LDFLAGS@
LIBS	:= ../../../Cxx-API/lib/libSynopsis.a @LIBS@
LIBRARY_EXT := @LIBEXT@

CTOOL_SO:= ctool$(LIBRARY_EXT)

HDR	:= $(patsubst $(srcdir)/%, %, $(wildcard $(srcdir)/*.hh))
SRC	:= Lexer.cc Grammar.cc Context.cc Declaration.cc Expression.cc ParseEnv.cc \
         File.cc Statement.cc Symbol.cc Token.cc Location.cc \
         Debugger.cc Printer.cc Translator.cc \
         ctool.cc
OBJ	:= $(patsubst %.cc, %.o, $(SRC))
DEP	:= $(patsubst %.cc, %.d, $(SRC))
HDR_SYN	:= $(patsubst %, %.syn, $(HDR))
CC_SYN	:= $(patsubst %.cc, %.cc.syn, $(filter-out Lexer.cc Grammar.cc, $(SRC)))

TARGET	:= $(CTOOL_SO)

vpath %.hh  $(srcdir)
vpath %.cc  $(srcdir)
vpath %.y  $(srcdir)
vpath %.l  $(srcdir)

all: $(TARGET)

doc: ctool.syn ctool-impl.syn

# Link C++ files together
ctool.syn: $(HDR_SYN)
	@echo linking C++ headers together
	$(synopsis) link_cxx --output=$@ $^

ctool-impl.syn: $(HDR_SYN) $(CC_SYN)
	@echo linking all C++ files together
	$(synopsis) link_cxx --output=$@ $^

$(CTOOL_SO): $(OBJ)
	$(CXX) -shared $(LDFLAGS) -o $@ $^ $(LIBS)

clean:
	rm -f $(CTOOL_SO)
	rm -rf Lexer.cc Grammar.cc Grammar.h $(OBJ) $(DEP) *.syn links xref

%.o:	%.cc
	$(CXX) $(CPPFLAGS) $(CXXFLAGS) -c -o $@ $<

%.d:	%.cc %.hh
	$(SHELL) -ec '$(MAKEDEP) $(CPPFLAGS) $< | sed "s/$*\\.o[ :]*/$*\\.d $*\\.o : /g" > $@'

# Compile C++ .hh files
$(HDR_SYN): %.syn: %
	@echo parsing $^
	$(synopsis) cxx --output=$@ $?

# Compile C++ .cc files
$(CC_SYN): %.cc.syn: %.cc
	@echo parsing $^
	$(synopsis) cxx --output=$@ $?

Lexer.cc: Lexer.l Grammar.hh
	$(LEX) $<
	mv lex.yy.c Lexer.cc

Grammar.cc Grammar.hh: Grammar.y
	$(YACC) -d -b Grammar -o Grammar.cc $<

ifeq (,$(filter $(MAKECMDGOALS), clean))
-include $(DEP)
endif
