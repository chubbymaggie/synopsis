#
# Copyright (C) 2004 Stefan Seefeld
# All rights reserved.
# Licensed to the public under the terms of the GNU LGPL (>= 2),
# see the file COPYING for details.
#

SHELL	:= /bin/sh

srcdir	:= @srcdir@

PYTHON	:= @PYTHON@

CC	:= @CC@
CXX	:= @CXX@
MAKEDEP	:= $(CXX) -M
YACC	:= @YACC@
LEX	:= @LEX@
CPPFLAGS:= @CPPFLAGS@ -I . -I $(srcdir) -I $(srcdir)/../../../include -I @PYTHON_INCLUDE@
CFLAGS	:= @CFLAGS@
CXXFLAGS:= @CXXFLAGS@
LDFLAGS	:= @LDFLAGS@
LIBS	:= @LIBS@ -lpthread
LIBRARY_EXT := @LIBEXT@

CTOOL_SO:= ctool$(LIBRARY_EXT)

SRC	:= Lexer.cc Grammar.cc Context.cc Declaration.cc Expression.cc ParseEnv.cc \
         File.cc Statement.cc Symbol.cc Token.cc Location.cc \
         PrintTraversal.cc Translator.cc \
         ctool.cc
HDR	:= $(patsubst $(srcdir)/include/%, %, $(wildcard $(abs_top_srcdir)/*.hh))
OBJ	:= $(patsubst %.cc, %.o, $(SRC))
DEP	:= $(patsubst %.cc, %.d, $(SRC))

TARGET	:= $(CTOOL_SO)

vpath %.hh  $(srcdir)
vpath %.cc  $(srcdir)
vpath %.y  $(srcdir)
vpath %.l  $(srcdir)

all: $(TARGET)

doc: #do nothing (yet)

$(CTOOL_SO): $(OBJ)
	$(CXX) -shared $(LDFLAGS) -o $@ $^ $(LIBS)

clean:
	rm -rf $(CTOOL_SO)
	rm -f Lexer.cc Grammar.cc Grammar.h $(OBJ) $(DEP)

%.o:	%.cc
	$(CXX) $(CPPFLAGS) $(CXXFLAGS) -c -o $@ $<

%.d:	%.cc %.hh
	$(SHELL) -ec '$(MAKEDEP) $(CPPFLAGS) $< | sed "s/$*\\.o[ :]*/$*\\.d $*\\.o : /g" > $@'

Lexer.cc: Lexer.l Grammar.hh
	$(LEX) $<
	mv lex.yy.c Lexer.cc

Grammar.cc Grammar.hh: Grammar.y
	$(YACC) -d -b Grammar -o Grammar.cc $<

ifeq (,$(filter $(MAKECMDGOALS), clean))
-include $(DEP)
endif
