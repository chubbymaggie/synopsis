# $Id: Makefile.in,v 1.6 2003/12/30 03:47:37 stefan Exp $
#
# This source file is a part of the Synopsis Project
# Copyright (C) 2003 Stefan Seefeld
#
# This library is free software; you can redistribute it and/or
# modify it under the terms of the GNU Library General Public
# License as published by the Free Software Foundation; either
# version 2 of the License, or (at your option) any later version.
#
# This library is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
# Library General Public License for more details.
#
# You should have received a copy of the GNU Library General Public
# License along with this library; if not, write to the
# Free Software Foundation, Inc., 675 Mass Ave, Cambridge,
# MA 02139, USA.

SHELL	:= /bin/sh

srcdir	:= @srcdir@

PYTHON	:= @PYTHON@

CC	:= @CC@
CXX	:= @CXX@
MAKEDEP	:= $(CXX) -M
YACC	:= @YACC@
LEX	:= @LEX@
CPPFLAGS:= @CPPFLAGS@ -I . -I $(srcdir) -I @PYTHON_INCLUDE@
CFLAGS	:= @CFLAGS@
CXXFLAGS:= @CXXFLAGS@
LDFLAGS	:= @LDFLAGS@
LIBS	:= @LIBS@ -lpthread
LIBRARY_EXT := @LIBEXT@

CTOOL_SO:= ctool$(LIBRARY_EXT)

SRC	:= Lexer.cc Grammar.cc Context.cc Declaration.cc Expression.cc ParseEnv.cc \
           Project.cc Statement.cc Symbol.cc Token.cc Location.cc \
           PrintTraversal.cc
HDR	:= $(patsubst $(srcdir)/include/%, %, $(wildcard $(abs_top_srcdir)/*.hh))
OBJ	:= $(patsubst %.cc, %.o, $(SRC))
DEP	:= $(patsubst %.cc, %.d, $(SRC))

TARGET	:= $(CTOOL_SO)

vpath %.hh  $(srcdir)
vpath %.cc  $(srcdir)
vpath %.y  $(srcdir)
vpath %.l  $(srcdir)

all: $(TARGET)

$(CTOOL_SO): $(OBJ)
	$(CXX) -shared $(LDFLAGS) -o $@ $^ $(LIBS)

clean:
	rm -rf $(CTOOL_SO)
	rm -f Lexer.cc Grammar.cc Grammar.h $(OBJ) $(DEP)

%.o:	%.cc
	$(CXX) $(CPPFLAGS) $(CXXFLAGS) -c -o $@ $<

%.d:	%.cc %.hh
	$(SHELL) -ec '$(MAKEDEP) $(CPPFLAGS) $< | sed "s/$*\\.o[ :]*/$*\\.d $*\\.o : /g" > $@'

Lexer.cc: Lexer.l Grammar.hh
	$(LEX) $<
	mv lex.yy.c Lexer.cc

Grammar.cc Grammar.hh: Grammar.y
	$(YACC) -d -b Grammar -o Grammar.cc $<

ifeq (,$(filter $(MAKECMDGOALS), clean))
-include $(DEP)
endif
