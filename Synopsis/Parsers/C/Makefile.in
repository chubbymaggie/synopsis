CC	:= @CC@
CXX	:= @CXX@
CPPFLAGS:= @CPPFLAGS@
MAKEDEP	:= $(CXX) -M
CFLAGS	:= @CFLAGS@
CXXFLAGS:= @CXXFLAGS@
LDFLAGS	:= -shared #@LDFLAGS@
LIBS	:= @LIBS@
AR	:= ar
RANLIB	:= @RANLIB@
LEX	:= @LEX@
YACC	:= @YACC@

RM	:= rm -f
MV	:= mv

CPP_PATH:=/usr/bin/cpp

CTOOLFLAGS:= -D USE_GCC_4_CPP -D DEBUG

CPPFLAGS+= -I . -D LIB_CPP=\"$(CPP_PATH)\" $(CTOOLFLAGS)
CXXFLAGS+= -g -Wall

SRC	:= lexer.cpp gram.cpp context.cpp decl.cpp express.cpp parseenv.cpp \
           project.cpp stemnt.cpp symbol.cpp token.cpp location.cpp \
           PrintTraversal.cpp
OBJ	:= $(patsubst %.cpp, %.o, $(SRC))
DEP	:= $(patsubst %.cpp, %.d, $(SRC))

all: ../lib/libctool.a ../lib/libctool.so

../lib/libctool.a: $(OBJ)
	@echo creating $(@F)
	$(AR) cr $@ $(OBJ)
	$(RANLIB) $@

../lib/libctool.so: $(OBJ)
	@echo linking $(@F)
	$(CXX) $(LDFLAGS) -o $@ $(OBJ) $(LIBS)

%.o:	%.cpp
	@echo compiling $(@F)
	$(CXX) $(CPPFLAGS) $(CXXFLAGS) -c -o $@ $<

%.d:	%.cpp %.h
	@echo generating dependencies for $(<F)
	$(SHELL) -ec '$(MAKEDEP) $(CPPFLAGS) $< | sed "s/$*\\.o[ :]*/$*\\.d $*\\.o : /g" > $@'

lexer.cpp: lexer.l gram.h
	$(LEX) $<
	$(MV) lex.yy.c lexer.cpp

gram.cpp gram.h:	gram.y
	$(YACC) -d -b gram -o gram.cpp $<
	$(MV) gram.hpp gram.h

clean:
	$(RM) lexer.cpp gram.cpp gram.h $(OBJ) 
	$(RM) ../lib/libctool.a ../lib/libctool.so

-include $(DEP)