#!/usr/bin/env python
#
# Copyright (C) 2004 Stefan Seefeld
# All rights reserved.
# Licensed to the public under the terms of the GNU LGPL (>= 2),
# see the file COPYING for details.
#

from Synopsis import config

from BaseHTTPServer import HTTPServer
from CGIHTTPServer import CGIHTTPRequestHandler
import sys, os, os.path, getopt, socket

class RequestHandler(CGIHTTPRequestHandler):
    """This little demo server emulates apache's 'Alias' and 'ScriptAlias'
    options to serve source files and data generated from sxr.cgi"""

    url = ''
    src = ''
    document_root = '.'
    debug = False

    def translate_path(self, path):
        """Translate URL into local path."""
      
        if path.endswith('sxr.cgi'):
            path = os.path.join(config.datadir, path[1:])
        else:
            path = os.path.join(self.document_root, path[1:])
        return path

    def is_cgi(self):
        """The path either refers to the sxr cgi or to a (source) file."""

        if self.path.startswith(self.url):
            self.cgi_info = ('/cgi-bin', 'sxr.cgi' + self.path[len(self.url):])
            return True
        return False
      

def usage():
   print 'Usage : %s [options] <input files>'%sys.argv[0]
   print """
List of options:

  -h, --help             help
  -d, --debug            print debug output
  -p, --port             port to listen for requests
  -r, --document_root    document root, i.e. top level directory (for things like stylesheets)
  -u, --url              base url under which to reach sxr.cgi
  -s, --src              base url under which to reach source files
"""

def run():

   port = 8000
   env = {}
   opts, args = getopt.getopt(sys.argv[1:],
                              'p:r:u:s:dh',
                              ['port=', 'document_root=', 'url=', 'src=',
                               'debug', 'help'])
   for o, a in opts:
      if o in ['-h', '--help']:
         usage()
         sys.exit(0)
      elif o in ['-p', '--port']:
         port = int(a)
      elif o in ['-r', '--document_root']:
         env['SXR_ROOT_DIR'] = a
         RequestHandler.document_root = a
      elif o in ['-u', '--url']:
         env['SXR_CGI_URL'] = a
         RequestHandler.url = a
      elif o in ['-s', '--src']:
         env['SXR_SRC_URL'] = a
         RequestHandler.src = a
      elif o in ['-d', '--debug']:
         RequestHandler.debug = True

   os.environ.update(env)

   httpd = HTTPServer(('', port), RequestHandler)
   print 'SXR server running, please connect to http://%s:%d ...'%(socket.gethostname(), port)
   try:
      httpd.serve_forever()
   except KeyboardInterrupt:
      print 'Keyboard Interrupt: exiting'

if __name__ == '__main__':
   run()

