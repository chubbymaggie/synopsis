#
# Copyright (C) 2003 Stefan Seefeld
# All rights reserved.
# Licensed to the public under the terms of the GNU LGPL (>= 2),
# see the file COPYING for details.
#

SHELL	:= /bin/sh

srcdir	:= @srcdir@
builddir:= @builddir@

PLATFORM:= @PLATFORM@
SYNOPSIS:= python synopsis.py
CXX	:= @CXX@
LDSHARED:= @LDSHARED@
LDSONAME:= @LDSONAME@
MAKEDEP	:= $(CXX) -M
AR	:= @AR@
RANLIB	:= @RANLIB@
LN_S	:= @LN_S@
CPPFLAGS:= @CPPFLAGS@ -D SYNOPSIS_SRC -I $(builddir) -I $(srcdir)
CXXFLAGS:= @CXXFLAGS@
LDFLAGS	:= @LDFLAGS@
LIBS	:= @LIBS@
DSO_EXT := @LIBEXT@
MAJOR	:= @MAJOR@
MINOR	:= @MINOR@

ifneq ($(findstring -fPIC, $(CXXFLAGS)),)
GC_CFLAGS := -fPIC
endif
GC_LIB	:= @GC_LIB@
ifdef GC_LIB
CPPFLAGS+= -I $(srcdir)/Synopsis/gc/include
endif

define make_dep
@echo generating dependencies for $(@D)/$(<F)
$(SHELL) -ec '$(MAKEDEP) $(CPPFLAGS) $< | sed "s,$(*F)\\.o[ :]*,$*\\.d $*\\.o : ,g" > $@'
endef

define compile
@echo compiling $(@D)/$(@F)
$(CXX) $(CPPFLAGS) $(CXXFLAGS) -c -o $@ $<
endef

ifneq ($(findstring $(PLATFORM), nt cygwin),)
define link_dso
@echo linking $@
$(LDSHARED) $(LDFLAGS) -o $@ $^ $(LIBS)
endef
else
define link_dso
@echo linking $@
rm -f $@ $@.$(MAJOR) $@.$(MAJOR).$(MINOR)
$(LDSHARED) $(LDFLAGS) $(LDSONAME)$(@F).$(MAJOR).$(MINOR) \
  -o $@.$(MAJOR).$(MINOR) $^ $(LIBS)
(cd $(@D) && $(LN_S) $(@F).$(MAJOR).$(MINOR) $(@F).$(MAJOR))
(cd $(@D) && $(LN_S) $(@F).$(MAJOR) $(@F))
endef
endif

define link_app
@echo linking $@
$(CXX) -Llib $(LDFLAGS) -o $@ $< -lSynopsis $(LIBS)
endef

SRC	:= Trace \
           PTree/Node PTree/Encoding PTree/operations \
           PTree/Atoms PTree/Lists PTree/generation \
           PTree/Visitor PTree/Display PTree/Writer \
           SymbolLookup/Symbol SymbolLookup/Scope SymbolLookup/Scopes \
           SymbolLookup/Display SymbolLookup/Walker \
           TypeAnalysis/Type TypeAnalysis/Kit \
           TypeAnalysis/TypeEvaluator \
           TypeAnalysis/ConstEvaluator \
           TypeAnalysis/OverloadResolver \
           Buffer Lexer SymbolFactory Parser

SRC 	:= $(patsubst %, Synopsis/%.cc, $(SRC))

SUP	:= $(patsubst %, Support/%.cc, Path ErrorHandler)

HDR	:= $(patsubst $(srcdir)/%, %, $(wildcard $(srcdir)/Synopsis/*.hh))
HDR	+= $(patsubst $(srcdir)/%, %, $(wildcard $(srcdir)/Synopsis/PTree/*.hh))
HDR	+= $(patsubst $(srcdir)/%, %, $(wildcard $(srcdir)/Synopsis/SymbolLookup/*.hh))
HDR	+= $(patsubst $(srcdir)/%, %, $(wildcard $(srcdir)/Synopsis/TypeAnalysis/*.hh))

OBJ	:= $(patsubst %.cc, %.o, $(SRC))
CC_SYN	:= $(patsubst %, %.sxr.syn, $(SRC))
HDR_SYN	:= $(patsubst %, %.syn, $(HDR))
HDR_SXR_SYN:= $(patsubst %, %.sxr.syn, $(HDR))
DEP	:= $(patsubst %.cc, %.d, $(SRC) tools/display-ptree.cc tools/display-symbols.cc)

LIBRARY	:= lib/libSynopsis$(DSO_EXT)
SUPPORT := lib/libSupport.a
TOOLS	:= bin/display-ptree bin/display-symbols
TARGETS	:= $(LIBRARY) $(SUPPORT) $(TOOLS)

vpath %.cc $(srcdir)
vpath %.c $(srcdir)
vpath %.h $(srcdir)
vpath %.hh $(srcdir) $(builddir)

all: $(TARGETS)

$(LIBRARY): $(OBJ) $(GC_LIB)
	$(link_dso)

$(SUPPORT): $(patsubst %.cc, %.o, $(SUP))
	$(AR) cru $@ $^
	$(RANLIB) $@

$(TOOLS): bin/%: tools/%.o $(LIBRARY)
	$(link_app)

doc: cxx.syn cxx-sxr.syn

cxx.syn: $(HDR_SYN)
	@echo linking C++ headers together
	$(SYNOPSIS) link --output=$@ $^

cxx-sxr.syn: $(HDR_SXR_SYN) $(CC_SYN)
	@echo linking all C++ files together
	$(SYNOPSIS) link --output=$@ $^

%.d: %.cc
	$(make_dep)

%.o: %.cc
	$(compile)

Makefile: $(srcdir)/Makefile.in
	./config.status --file Makefile

$(HDR_SYN): %.syn: %
	@echo parsing $^
	mkdir -p $(dir $@)
	$(SYNOPSIS) cxx --output=$@ $?

$(HDR_SXR_SYN): %.sxr.syn: %
	@echo parsing $^
	mkdir -p $(dir $@)
	$(SYNOPSIS) cxx_sxr --output=$@ $?

$(CC_SYN): %.cc.sxr.syn: %.cc
	@echo parsing $^
	mkdir -p $(dir $@)
	$(SYNOPSIS) cxx_sxr --output=$@ $?

# This calls make in the gc dir to create the gc.a file
$(GC_LIB):
	$(MAKE) -C Synopsis/gc GC_CFLAGS=$(GC_CFLAGS)

clean :
	rm -f Synopsis/*~ Synopsis/*.o Synopsis/*.d Synopsis/*.syn \
        Synopsis/PTree/*.~ Synopsis/PTree/*.o Synopsis/PTree/*.d Synopsis/PTree/*.syn \
        Synopsis/SymbolLookup/*.~ Synopsis/SymbolLookup/*.o Synopsis/SymbolLookup/*.d Synopsis/SymbolLookup/*.syn \
        Synopsis/TypeAnalysis/*.~ Synopsis/TypeAnalysis/*.o Synopsis/TypeAnalysis/*.d Synopsis/TypeAnalysis/*.syn \
        tools/*.~ tools/*.o tools/*.d \
        *.dll *.so *core \
	base_lib

ifeq (,$(filter $(MAKECMDGOALS), depend clean distclean))
-include $(DEP)
endif
